= DIYStateGraph

APIgee EDGE system has many components. EDGE is a sophisticated and complex distributed system. EDGE has evolved over a few years, a few revisions and a few teams to serve its functionality. Current state of the tools and system do not maintain consistent view of the system state.
More details at : https://apigeesc.atlassian.net/wiki/display/EH/DevOpsSystem-DIA
'''

*Table of Contents*


'''

=== DIY State Graph

image::http://raw.github.com/neo4j-contrib/gists/master/other/images/datacenter-management-1.PNG[Network Dependency Graph]

=== Database Setup

Below you will find the full Cypher script for creating DIY satate graph. This simple script is the full setup of the data set that we will later perform analysis on.

//setup
[source,cypher]
----
// Create Customer
CREATE (Walgreens:Customer { 
			id:'Customer1', 
			name:'Walgreens',
			AccountType: 'CLOUD',
			Provider: 'AWS',
			isActive : 'ACTIVE',
		}) 
	
	
		
//Create organization
CREATE (Developer-org:Organization { 
			id:'org1', 
			name:'Developer',
		})

CREATE (Internal-org:Organization { 
			id:'org12', 
			name:'Internal',
		})


		
//Create Environment
CREATE(Env-test:Environment{
			id:"walTest"
			name: "Test"
})


CREATE(Env-prod:Environment{
			id:"walProd"
			name: "Productions"
})

		
//create Order
CREATE (Order-Edge250:Order { 
			id:'Order123', 
			SLA:'25M/quater',
		}) 

CREATE (Order-APIBAAS250:Order { 
			id:'Order456', 
			SLA:'25M/quater',
		})
		
CREATE (Order-DeveloperService250:Order { 
			id:'Order789', 
			SLA:'1000 users',
		})
		
CREATE (Order-AnalyticsService250:Order { 
			id:'Order1011', 
			SLA:'1TBStorage/quater',
		})	
//create product
CREATE (Edge:Product { 
			id:'Edge', 
			name:'Edge'
		})
CREATE (Insight:Product { 
			id:'Insights', 
			name:'Insights'
		})
		
		
//create Product Instance

CREATE (Edge250:ProductInstance { 
			id:'Edge250', 
			SLA:'25M calls /quater',
		})
		
CREATE (Edge500:ProductInstance { 
			id:'Edge500', 
			SLA:'50M calls /quater',
		})

CREATE (Edge1250:ProductInstance { 
			id:'Edge500', 
			SLA:'1250M calls /quater',
		})
		
CREATE (Insights250:ProductInstance { 
			id:'Insight3', 
			SLA:'1TB /quater',
		})
		

//create SKU		
CREATE (E250-Edge250:SKU { 
			id:'sku250',
			name:'Edge 250',
		})
		
CREATE (E2520-EnterpriseFeaturePack:SKU { 
			id:'sku2520',
			name:'Enterprise Feature pack',
		})
		
CREATE (E25040-Monetization:SKU { 
			id:'sku25040',
			name:'Monetization Pack',
		})

CREATE (I100-InsightsCTM:SKU { 
			id:'skuI100',
			name:'Insights CTM Cloud',
		})
		
// create Proxy Bundle

CREATE (APIPlatform:proxy-bundle { 
			id:'proxy1',
			name:'APIPlatform',
		})
		
CREATE (APIBAAS:proxy-bundle { 
			id:'proxy2',
			name:'API BAAS',
		})
		
CREATE (AnalyticsService:proxy-bundle { 
			id:'proxy3',
			name:'Analytics Service',
		})
		
		
//Create Component
CREATE (Message-Processor:Component { 
			id:'comp1',
			name:'Message Processor',
			type:'Dedicated'
		})
CREATE (Router:Component { 
			id:'comp2',
			name:'Router',
			type:'Shared'
		})

CREATE (Dynect:Component { 
			id:'comp3',
			name:'Dynect',
			type:'Shared'
		})

CREATE (ELB:Component { 
			id:'comp4',
			name:'ELB',
			type:'Dedicated'
		})

CREATE (Cassandra:Component { 
			id:'comp5',
			name:'Cassandra',
			type:'Shared'
		})
		
CREATE (UserGrid-tomcat:Component { 
			id:'comp6',
			name:'tomcat',
			type:'Dedicated',
		})		
CREATE (UserGrid-Cassandra:Component { 
			id:'comp7',
			name:'User grid Cassandra',
			type:'Shared'
		})

//create provider		
CREATE (AWS:Provider {
			id:'provider-aws',
			name:'AWS',
			Type:"public"
		})
CREATE (RackSpace:Provider {
			id:'provider-rackspace',
			name:'RackSpace',
			Type:"private"
		})


//create Compute/storage/network Instance Type
CREATE (c3.xlarge:ComputeInstance {
			id:'aws-instance1',
			UUID:'ABCD',
			Type:'compute',
			Size:'Xlarge',
			vCpu:'4',
			Memory:'7.5GB',
			SSD:'2X40'
			
		})
CREATE (i2.xlarge:ComputeInstance {
			id:'aws-instance2',
			UUID:'ABCDE',
			Type:'Storage',
			Size:'Xlarge',
			vCpu:'4',
			Memory:'20GB',
			SSD:'1X800'
			
		})
		
CREATE (r1.large:ComputeInstance {
			id:'rackspace-instance3',
			UUID:'ABCDF',
			Type:'compute',
			Size:'large',
			vCpu:'4',
			Memory:'8GB',
			SSD:'1X40'
			
		})		

//Connect customer to orgs
CREATE ((Developer-org)-[:BELONG_TO]->(Walgreens)
CREATE ((Internal-org)-[:BELONG_TO]->(Walgreens)

//Connect Environment to org
CREATE ((Env-prod)-[:SUPPORTED_IN]->(Developer-org)
CREATE ((Env-test)-[:SUPPORTED_IN]->(Developer-org)
CREATE ((Env-prod)-[:SUPPORTED_IN]->(Internal-org)

//Connect Order to customer
CREATE ((Order-APIBAAS250)-[:PLACED_FOR]->(Walgreens)
CREATE ((Order-DeveloperService250)-[:PLACED_FOR]->(Walgreens)
CREATE ((Order-AnalyticsService250)-[:PLACED_FOR]->(Walgreens)


//Connect product instance with product TODO:add sla in connection property

CREATE ((Edge250)-[:INSTANCE_OF {SLA:'250M/Quater'}]->(Edge)
CREATE ((Edge500)-[:INSTANCE_OF {SLA:'500M/Quater'}]->(Edge)
CREATE ((Edge1250)-[:INSTANCE_OF {SLA:'1250M/Quater'}]->(Edge)
CREATE ((Insights250)-[:INSTANCE_OF {SLA:'1TB/Quater'}]->(Insight)

//connect SKU to product instance
CREATE ((Edge250)-[:OFFERS]->(E250-Edge250)
CREATE ((Edge250)-[:OFFERS]->(E2520-EnterpriseFeaturePack)
CREATE ((Edge250)-[:OFFERS]->(E25040-Monetization)
CREATE ((Insights250)-[:OFFERS]->(I100-InsightsCTM)

//connect proxy bundle with SKU

CREATE ((APIPlatform)-[:BUNDLES {Quantity:'2'}]->(Message-Processor)-[:SERVES]->(Edge250)
CREATE ((APIPlatform)-[:BUNDLES {Quantity:'4'}]->(Message-Processor)-[:SERVES]->(Edge500)

CREATE ((APIPlatform)-[:BUNDLES {Quantity:'2'}]->(Router)-[:SERVES]->(Edge250)
CREATE ((APIPlatform)-[:BUNDLES {Quantity:'4'}]->(Router)-[:SERVES]->(Edge500)

CREATE ((APIPlatform)-[:BUNDLES {Quantity:'1'}]->(Dynect)-[:SERVES]->(Edge250)
CREATE ((APIPlatform)-[:BUNDLES {Quantity:'1'}]->(Dynect)-[:SERVES]->(Edge500)

CREATE ((APIPlatform)-[:BUNDLES {Quantity:'2'}]->(ELB)-[:SERVES]->(Edge250)
CREATE ((APIPlatform)-[:BUNDLES {Quantity:'2'}]->(ELB)-[:SERVES]->(Edge500)

CREATE ((APIPlatform)-[:BUNDLES {Quantity:'6'}]->(Cassandra)-[:SERVES]->(Edge250)
CREATE ((APIPlatform)-[:BUNDLES {Quantity:'6'}]->(Cassandra)-[:SERVES]->(Edge500)

CREATE ((APIBAAS)-[:BUNDLES {Quantity:'2'}]->(UserGrid-tomcat)-[:SERVES]->(Edge250)
CREATE ((APIBAAS)-[:BUNDLES {Quantity:'4'}]->(UserGrid-tomcat)-[:SERVES]->(Edge500)

CREATE ((APIBAAS)-[:BUNDLES {Quantity:'2'}]->(UserGrid-Cassandra)-[:SERVES]->(Edge250)
CREATE ((APIBAAS)-[:BUNDLES {Quantity:'4'}]->(UserGrid-Cassandra)-[:SERVES]->(Edge500)


RETURN *

----

'''

=== Interactive Graph Visualization
//graph

'''

=== ACME's Network Inventory

The query below generates a data table that gives a quick overview of ACME's network infrastructure.

[source,cypher]
----
MATCH 	(n) 
RETURN 	labels(n)[0] as type,
		count(*) as count, 
		collect(n.host) as names
----

//table

'''

=== Find direct dependencies of all public websites

The query below queries the data model to find all business web applications that are on the public facing internet for ACME.

[source,cypher]
----
MATCH 		(website)-[:DEPENDS_ON]->(downstream)
WHERE		website.system = "INTERNET"
RETURN 		website.host as Host, 
			collect(downstream.host) as Dependencies
ORDER BY 	Host
----

//table

'''

=== Find direct dependencies of all internal websites

The query below queries the data model to find all business websites that are on the private intranet for ACME.

[source,cypher]
----
MATCH 		(website)-[:DEPENDS_ON]->(downstream)
WHERE		website.system = "INTRANET"
RETURN 		website.host as Host, 
			collect(downstream.host) as Dependencies
ORDER BY 	Host
----

//table

'''

=== Find the most depended-upon component

The query below finds the most heavily relied upon component within ACME's network infrastructure. As expected, the most depended upon component is the SAN (Storage Area Network).

[source,cypher]
----
MATCH 		(n)<-[:DEPENDS_ON*]-(dependent)
RETURN 		n.host as Host, 
			count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT 		1
----

//table

'''

=== Find dependency chain for business critical components:  CRM

The query below finds the path of dependent components from left to right for ACME's CRM application. If ACME's CRM (Customer Relationship Management) application goes down it will cause significant impacts to its business. If any one of the components to the right of the CRM hostname fails, the CRM application will fail.

[source,cypher]
----
MATCH 		(dependency)<-[:DEPENDS_ON*]-(dependent)
WITH 		dependency, count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT		1
WITH		dependency
MATCH 		p=(resource)-[:DEPENDS_ON*]->(dependency)
WHERE		resource.system = "CRM"
RETURN		"[" + head(nodes(p)).host + "]" + 
			reduce(s = "", n in tail(nodes(p)) | s + " -> " + "[" + n.host + "]") as Chain
----

//table

'''

=== Find dependency chain for business critical components:  ERP

The query below finds the path of dependent components from left to right for ACME's ERP (Enterprise Resource Planning) application. The ERP application represents an array of business resources dedicated to supporting ongoing business activities at ACME, including finance and supply chain management. If ACME's ERP application goes down it will cause significant impacts to its business. If any one of the components to the right of the ERP hostname fails, then the ERP application will fail. This failure will cause revenue impacts since ACME's business relies on this system to conduct business.

[source,cypher]
----
MATCH 		(dependency)<-[:DEPENDS_ON*]-(dependent)
WITH 		dependency, count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT		1
WITH		dependency
MATCH 		p=(resource)-[:DEPENDS_ON*]->(dependency)
WHERE		resource.system = "ERP"
RETURN		"[" + head(nodes(p)).host + "]" + 
			reduce(s = "", n in tail(nodes(p)) | s + " -> " + "[" + n.host + "]") as Chain
----

//table

'''

=== Find dependency chain for business critical components: Data Warehouse

The query below finds the path of dependent components from left to right for ACME's DW (Data Warehouse) application. The DW application represents an array of business intelligence resources dedicated to supporting time-sensitive analytical processes at ACME. If ACME's DW application goes down it will cause significant impacts to the business operations at ACME on the technical side. If any one of the components to the right of the DW hostname fails, then the DW application will fail. This failure will cause public facing websites like the eCommerce application to not reflect the latest available data from ACME's ERP application.

[source,cypher]
----
MATCH 		(dependency)<-[:DEPENDS_ON*]-(dependent)
WITH 		dependency, count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT		1
WITH		dependency
MATCH 		p=(resource)-[:DEPENDS_ON*]->(dependency)
WHERE		resource.system = "DW"
RETURN		"[" + head(nodes(p)).host + "]" + 
			reduce(s = "", n in tail(nodes(p)) | s + " -> " + "[" + n.host + "]") as Chain
----

//table

=== Find the impact of the removal of a network component : Hardware Server

The query below finds the applications depending on ACME's HARDWARE-SERVER-3. In case a network administrator wants to plan an intervention on the server, he has to know what will be the applications impacted. This way he can warn the applications users.

[source,cypher]
----
MATCH (application:Application)-[:DEPENDS_ON*]->(server)
WHERE       server.host = "HARDWARE-SERVER-3"
RETURN  application.type as Type,
        application.host as Host
----

//table
